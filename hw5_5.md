# Домашнее задание к занятию "5. Оркестрация кластером Docker контейнеров на примере Docker Swarm"

---
---

## Задача 1

Дайте письменые ответы на следующие вопросы:

- В чём отличие режимов работы сервисов в Docker Swarm кластере: replication и global?
- Какой алгоритм выбора лидера используется в Docker Swarm кластере?
- Что такое Overlay Network?
## Ответ

- В режиме replication приложение запускается в том количестве экземпляров, какое укажет пользователь. 
При этом на отдельной node может быть как несколько экземпляров приложения, так и не быть совсем.
В режиме global приложение запускается обязательно на каждой node и в единственном экземпляре.

- В Docker Swarm кластере используется так называемый алгоритм поддержания распределенного консенсуса - Raft.

Протокол решает проблему согласованности - чтобы все manager-ноды имели одинаковое представление 
о состоянии кластера. Для отказоустойчивой работы лучше чтобы было не менее 3 manager-нод.
Среди manager-нод выбирается лидер, его задача гарантировать согласованность. Лидер отправляет keepalive-пакеты с заданной периодичностью в пределах 150-300мс. 
Если пакеты не пришли, менеджеры начинают выборы нового лидера.

- Overlay network - это внутренняя виртуальная сеть кластера docker swarm, которая упрощает взаимодействие узлов кластера между собой.

## Задача 2

Создать ваш первый Docker Swarm кластер в Яндекс.Облаке

Для получения зачета, вам необходимо предоставить скриншот из терминала (консоли), с выводом команды:
```
docker node ls
```
## Ответ
Содержимое playbook.yml:
```
---
- name: 'Playbook'
  hosts: nodes
  become: true
  become_method: enable

  tasks:
    - name: Installing tools
      yum:
        package: "{{ item }}"
        state: present
        update_cache: yes
      with_items:
        - git
        - curl
    - name: Installing repo
      shell: sudo yum install -y epel-release

    - name: Installing python3
      shell: sudo yum install -y python36

    - name: Installing docker
      shell: sudo curl -fsSL get.docker.com -o get-docker.sh && sudo chmod +x get-docker.sh && sudo ./get-docker.sh

    - name: Add the current user to docker group
      user:
        name: centos
        append: yes
        groups: docker
```

При запуске не отрабатывает под sudo, хотя и параметр become: true стоит, и даже become_method: enable добавил, даже sudo в командах. Попробовал подключиться к удаленной машине, под sudo все отрабатывает. В чем может быть проблема?
>ansible-playbook -i inventory/hosts -v --check --become --private-key ~/.ssh/id_ed25519 playbook.yml

```
[centos@localhost ansible]$ ansible-playbook -i inventory/hosts -v --check --become --private-key ~/.ssh/id_ed25519 playbook.yml
Using /home/centos/Netology_Project/virt-homeworks/05-virt-05-docker-swarm/src/terraform/virt-video-code/ansible/ansible.cfg as config file

PLAY [Playbook] *****************************************************************************************

TASK [Gathering Facts] **********************************************************************************
ok: [158.160.36.219]
ok: [158.160.47.91]
ok: [158.160.60.25]
ok: [84.201.135.131]
ok: [158.160.35.223]
ok: [51.250.90.86]

TASK [Installing tools] *********************************************************************************
ok: [158.160.47.91] => (item=[u'git', u'curl']) => {"ansible_loop_var": "item", "changed": false, "item": ["git", "curl"], "msg": "", "rc": 0, "results": ["git-1.8.3.1-24.el7_9.x86_64 providing git is already installed", "curl-7.29.0-59.el7_9.1.x86_64 providing curl is already installed"]}
ok: [158.160.35.223] => (item=[u'git', u'curl']) => {"ansible_loop_var": "item", "changed": false, "item": ["git", "curl"], "msg": "", "rc": 0, "results": ["git-1.8.3.1-24.el7_9.x86_64 providing git is already installed", "curl-7.29.0-59.el7_9.1.x86_64 providing curl is already installed"]}
ok: [158.160.36.219] => (item=[u'git', u'curl']) => {"ansible_loop_var": "item", "changed": false, "item": ["git", "curl"], "msg": "", "rc": 0, "results": ["git-1.8.3.1-24.el7_9.x86_64 providing git is already installed", "curl-7.29.0-59.el7_9.1.x86_64 providing curl is already installed"]}
ok: [84.201.135.131] => (item=[u'git', u'curl']) => {"ansible_loop_var": "item", "changed": false, "item": ["git", "curl"], "msg": "", "rc": 0, "results": ["git-1.8.3.1-24.el7_9.x86_64 providing git is already installed", "curl-7.29.0-59.el7_9.1.x86_64 providing curl is already installed"]}
ok: [158.160.60.25] => (item=[u'git', u'curl']) => {"ansible_loop_var": "item", "changed": false, "item": ["git", "curl"], "msg": "", "rc": 0, "results": ["git-1.8.3.1-24.el7_9.x86_64 providing git is already installed", "curl-7.29.0-59.el7_9.1.x86_64 providing curl is already installed"]}
ok: [51.250.90.86] => (item=[u'git', u'curl']) => {"ansible_loop_var": "item", "changed": false, "item": ["git", "curl"], "msg": "", "rc": 0, "results": ["git-1.8.3.1-24.el7_9.x86_64 providing git is already installed", "curl-7.29.0-59.el7_9.1.x86_64 providing curl is already installed"]}

TASK [Installing repo] **********************************************************************************
skipping: [158.160.47.91] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.35.223] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [84.201.135.131] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.60.25] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.36.219] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [51.250.90.86] => {"changed": false, "msg": "skipped, running in check mode"}

TASK [Installing python3] *******************************************************************************
skipping: [158.160.47.91] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.35.223] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.36.219] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [84.201.135.131] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.60.25] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [51.250.90.86] => {"changed": false, "msg": "skipped, running in check mode"}

TASK [Installing docker] ********************************************************************************
skipping: [158.160.35.223] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.47.91] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.36.219] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [84.201.135.131] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [158.160.60.25] => {"changed": false, "msg": "skipped, running in check mode"}
skipping: [51.250.90.86] => {"changed": false, "msg": "skipped, running in check mode"}

TASK [Add the current user to docker group] *************************************************************
fatal: [158.160.60.25]: FAILED! => {"changed": false, "msg": "Group docker does not exist"}
fatal: [158.160.47.91]: FAILED! => {"changed": false, "msg": "Group docker does not exist"}
fatal: [158.160.35.223]: FAILED! => {"changed": false, "msg": "Group docker does not exist"}
fatal: [84.201.135.131]: FAILED! => {"changed": false, "msg": "Group docker does not exist"}
fatal: [158.160.36.219]: FAILED! => {"changed": false, "msg": "Group docker does not exist"}
fatal: [51.250.90.86]: FAILED! => {"changed": false, "msg": "Group docker does not exist"}

PLAY RECAP **********************************************************************************************
158.160.35.223             : ok=2    changed=0    unreachable=0    failed=1    skipped=3    rescued=0    ignored=0
158.160.36.219             : ok=2    changed=0    unreachable=0    failed=1    skipped=3    rescued=0    ignored=0
158.160.47.91              : ok=2    changed=0    unreachable=0    failed=1    skipped=3    rescued=0    ignored=0
158.160.60.25              : ok=2    changed=0    unreachable=0    failed=1    skipped=3    rescued=0    ignored=0
51.250.90.86               : ok=2    changed=0    unreachable=0    failed=1    skipped=3    rescued=0    ignored=0
84.201.135.131             : ok=2    changed=0    unreachable=0    failed=1    skipped=3    rescued=0    ignored=0
```

## Задача 3

Создать ваш первый, готовый к боевой эксплуатации кластер мониторинга, состоящий из стека микросервисов.

Для получения зачета, вам необходимо предоставить скриншот из терминала (консоли), с выводом команды:
```
docker service ls
```

## Задача 4 (*)

Выполнить на лидере Docker Swarm кластера команду (указанную ниже) и дать письменное описание её функционала, что она делает и зачем она нужна:
```
# см.документацию: https://docs.docker.com/engine/swarm/swarm_manager_locking/
docker swarm update --autolock=true
```

